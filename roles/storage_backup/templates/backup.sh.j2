#!/bin/bash

storage=false
prune=false

function usage {
    cat << HELP
Usage:
$(basename $0) [options]

Options:
-s                          Perform Storage Backup.
-p                          Prune backups older than {{ storage_backup_retention }} days
HELP
}

while getopts ":sph" opt; do case ${opt} in
    h ) usage; exit 0;;
    s ) storage=true;;
    p ) prune=true;;
    \? ) printf "Invalid Option: -$OPTARG\n\n" 1>&2; usage; exit 1;;
esac; done
if [ $OPTIND -eq 1 ]; then printf "Invalid Option: $(basename $0) requires options.\nRun $(basename $0) -h for help.\n" 1>&2; exit 1; fi
shift $((OPTIND -1))

export BORG_PASSPHRASE={{ storage_backup_password }}

if [ $prune = true ]; then # Prune old backups
    borg prune --keep-within {{ storage_backup_retention }}d "{{ storage_backup_dir }}"
fi

if [ $storage = true ]; then # Storage Backup
    borg create -C {{ storage_backup_compression }} "{{ storage_backup_dir }}" "{{ storage_export }}"
fi

unset BORG_PASSPHRASE
