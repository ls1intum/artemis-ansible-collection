#!/bin/bash

PROJECT_DIR="{{ weaviate_working_directory }}"
COMPOSE_FILE="docker-compose.yml"
ENV_FILE="{{ weaviate_working_directory }}/.env"

# Function: Print general usage information
function general_help {
    cat << HELP
Usage:
  ./$(basename "$0") <command> [options]

Commands:
  start                           Start Weaviate, Traefik and multi2vec-clip
  stop                            Stop all Weaviate services
  restart                         Restart all Weaviate services
  logs [service]                  Show logs (optionally for specific service)
  backup                          Create a backup of Weaviate data
  restore <backup-id>             Restore from a backup
  status                          Show status of all services
  run <docker compose cmd>        Run any docker compose subcommand of your choice
HELP
}

function start {
    echo "Starting Weaviate services..."
    docker compose --project-directory "$PROJECT_DIR" -f "$PROJECT_DIR/$COMPOSE_FILE" --env-file "$ENV_FILE" up -d --pull always
}

function stop {
    echo "Stopping Weaviate services..."
    docker compose --project-directory "$PROJECT_DIR" -f "$PROJECT_DIR/$COMPOSE_FILE" --env-file "$ENV_FILE" down
}

function restart {
    stop
    start
}

function logs {
    local service=$1
    if [ -z "$service" ]; then
        echo "Showing logs for all services..."
        docker compose --project-directory "$PROJECT_DIR" -f "$PROJECT_DIR/$COMPOSE_FILE" --env-file "$ENV_FILE" logs -f
    else
        echo "Showing logs for $service..."
        docker compose --project-directory "$PROJECT_DIR" -f "$PROJECT_DIR/$COMPOSE_FILE" --env-file "$ENV_FILE" logs -f "$service"
    fi
}

function backup {
    echo "Creating backup..."
    cd "$PROJECT_DIR" && ./backup.sh
}

function restore {
    local backup_id=$1
    if [ -z "$backup_id" ]; then
        echo "Error: Backup ID required"
        echo "Usage: ./$(basename "$0") restore <backup-id>"
        exit 1
    fi
    echo "Restoring from backup: $backup_id"
    cd "$PROJECT_DIR" && ./restore.sh "$backup_id"
}

function status {
    echo "Weaviate services status:"
    docker compose --project-directory "$PROJECT_DIR" -f "$PROJECT_DIR/$COMPOSE_FILE" --env-file "$ENV_FILE" ps
}

function run_docker_compose_cmd {
    docker compose --project-directory "$PROJECT_DIR" -f "$PROJECT_DIR/$COMPOSE_FILE" --env-file "$ENV_FILE" "$@"
}

# read subcommand `weaviate-docker subcommand server` in variable and remove base command from argument list
subcommand=$1; shift

# Handle empty subcommand
if [ -z "$subcommand" ]; then
    general_help
    exit 1
fi

case "$subcommand" in
    start)
        start "$@"
        ;;
    stop)
        stop "$@"
        ;;
    restart)
        restart "$@"
        ;;
    logs)
        logs "$@"
        ;;
    backup)
        backup "$@"
        ;;
    restore)
        restore "$@"
        ;;
    status)
        status "$@"
        ;;
    run)
        run_docker_compose_cmd "$@"
        ;;
    *)
        printf "Invalid Command: $subcommand\n\n" 1>&2
        general_help
        exit 1
        ;;
esac
