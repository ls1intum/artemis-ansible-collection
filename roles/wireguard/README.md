# Wireguard

This role creates a wireguard VPN between a group of servers. Each server in the host group can connect to each other node.

## Configuration

To configure the role, you need to set the required variables in your Ansible playbook or inventory. The following variables are required:

- `wireguard_host_ipv6_address`: The IPv6 address (with CIDR) which can be used to access the node. If left blank, Ansible will use host facts to fill the address.
- `host_ipv4_address`: The IPv4 address of the host.
- `wireguard_interface_address`: The address of the node inside the network.
- `wireguard_pubkey`: The public key for Wireguard.
- `wireguard_privkey`: The private key for Wireguard.
- `wireguard_hostgroup`: The host group from your inventory which contains all the hosts that should be connected to each other.

Default variables can be found in the `defaults/main.yml` file.

### Variables that have to be configured:

```
# IPv6 address (with CIDR!) which can be used to access the node - If left blank, ansible will use host facts to fill the address.
wireguard_host_ipv6_address:
host_ipv4_address:

# Address of the node inside the network.
wireguard_interface_address: "fcfe:0:0:0:0:0:a:1"

# Wireguard Keys - Autmatically generated!
wireguard_pubkey: 
wireguard_privkey: 
```

You have to define a host group from your inventory which contains all the hosts that should be connected to each other:
```
wireguard_hostgroup: "{{ groups.<group_name_here> }}"
```

## Example Usage

Here is an example playbook:

```yaml
- hosts: wireguard
  roles:
    - role: ls1intum.wireguard
      vars:
        wireguard_host_ipv6_address: "fcfe:0:0:0:0:0:a:1/128"
        host_ipv4_address: "192.168.1.1"
        wireguard_interface_address: "fcfe:0:0:0:0:0:a:1"
        wireguard_pubkey: "your_public_key"
        wireguard_privkey: "your_private_key"
        wireguard_hostgroup: "{{ groups.yourgroup }}"
```

## Automatic `host_var` generation

This role contains a python script to generate the `host_var` files. Make sure to install the wireguard tools first - The python script uses the `wg` command to generate the keys.

You have to configure the host prefix for your variables.

```
python3 host_var_gen.py --hostprefix artemis_ --hostsuffix .ase.in.tum.de
```
This will generate:
```
artemis_broker.ase.in.tum.de.yml
artemis_db.ase.in.tum.de.yml
artemis_node.ase.in.tum.de.yml
artemis_proxy.ase.in.tum.de.yml
artemis_storage.ase.in.tum.de.yml
```

You can specify the desired number of hosts with the script - Consult the script help for details:

```
python3 host_var_gen.py -h
```

## Manual Key generation

The wireguard keys can be generated by hand with:
```
wg genkey | tee peer_A.priv | wg pubkey > peer_A.pub
```
